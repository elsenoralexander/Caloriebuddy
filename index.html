<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1"
  />
  <title>Calculadora de Calor√≠as ‚Äî Diario</title>

  <!-- TailwindCSS CDN para prototipado r√°pido -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Fondo degradado + glassmorphism */
    body {
      min-height: 100vh;
      background: radial-gradient(1250px 600px at 10% 10%, #0ea5e9 0%, #0b1324 50%, #0b1324 100%),
                  radial-gradient(1000px 400px at 90% 30%, #22c55e3d 0%, transparent 60%) no-repeat;
      color: #eaeef7;
    }
    .glass {
      backdrop-filter: blur(12px);
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .chip {
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(10px);
    }
    .btn {
      transition: transform .05s ease, opacity .2s ease;
    }
    .btn:active { transform: translateY(1px); }
    .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .hidden-input { display: none; }
    .kbd {
      padding: .1rem .4rem; border-radius: .3rem;
      background: rgba(255,255,255,.1); border: 1px solid rgba(255,255,255,.2)
    }
  </style>
</head>
<body class="antialiased">
  <header class="max-w-6xl mx-auto px-4 py-6">
    <div class="flex items-center justify-between">
      <h1 class="text-2xl md:text-3xl font-bold">
        ü•ó Calculadora de Calor√≠as ‚Äî <span class="text-sky-300">Diario</span>
      </h1>
      <div class="flex items-center gap-2">
        <button id="openSettingsBtn" class="btn chip px-3 py-2 rounded-xl text-sm hover:opacity-90">‚öôÔ∏è Ajustes</button>
        <div id="userTag" class="chip px-3 py-2 rounded-xl text-xs">UID: <span id="uidSpan">Cargando‚Ä¶</span></div>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-24">
    <!-- Panel Superior: objetivo y resumen del d√≠a -->
    <section class="glass rounded-2xl p-5 md:p-6 mb-6">
      <div class="grid md:grid-cols-4 gap-4 md:gap-6 items-start">
        <div class="md:col-span-3">
          <h2 class="text-xl font-semibold mb-3">Resumen de hoy <span id="todayLabel" class="text-sky-300"></span></h2>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <div class="chip rounded-xl p-3">
              <div class="text-xs opacity-80">Ingestas</div>
              <div id="ingestasTotal" class="text-2xl mono">0</div>
              <div class="text-xs opacity-70">kcal</div>
            </div>
            <div class="chip rounded-xl p-3">
              <div class="text-xs opacity-80">Consumos</div>
              <div id="consumosTotal" class="text-2xl mono">0</div>
              <div class="text-xs opacity-70">kcal</div>
            </div>
            <div class="chip rounded-xl p-3">
              <div class="text-xs opacity-80">Meta diaria</div>
              <div class="flex items-end gap-2">
                <input id="metaInput" type="number" class="w-24 bg-transparent mono outline-none"
                       min="0" step="10" value="2000" />
                <button id="saveMetaBtn" class="btn text-xs chip px-2 py-1 rounded-lg">Guardar</button>
              </div>
            </div>
            <div class="chip rounded-xl p-3">
              <div class="text-xs opacity-80">Balance</div>
              <div id="balanceSpan" class="text-2xl mono">0</div>
              <div class="text-xs opacity-70">kcal (negativo = d√©ficit)</div>
            </div>
          </div>
        </div>
        <div class="md:col-span-1">
          <div class="chip rounded-xl p-3">
            <div class="text-xs opacity-80 mb-1">Consistencia</div>
            <div class="text-xs opacity-90">
              Guardamos tus equivalencias en la nube. Ejemplo ya incluido: <b>‚Äúcaf√© con leche‚Äù = 90 kcal</b>. Si repites,
              se usa ese valor salvo que especifiques lo contrario.
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Ingestas -->
    <section class="glass rounded-2xl p-5 md:p-6 mb-6">
      <h3 class="text-lg font-semibold mb-3">‚ûï Nueva ingesta</h3>
      <div class="grid md:grid-cols-2 gap-4">
        <!-- Columna de entrada -->
        <div class="space-y-3">
          <div class="chip rounded-xl p-3">
            <label class="text-sm opacity-80">Descripci√≥n</label>
            <input id="ingDesc" type="text" class="w-full bg-transparent outline-none"
              placeholder='Ej.: "caf√© con leche" o "ensalada con 100g de at√∫n y 2cs de aceite"' />
          </div>

          <div class="flex items-center gap-3">
            <label class="btn chip rounded-xl px-3 py-2 cursor-pointer text-sm">
              üì∑ Adjuntar foto
              <input id="ingFile" type="file" accept="image/*" class="hidden-input" />
            </label>
            <button id="ingAI" class="btn chip rounded-xl px-3 py-2 text-sm hover:opacity-90">
              ü§ñ Calcular con IA
            </button>
            <span id="ingAIStatus" class="text-xs opacity-75"></span>
          </div>

          <div class="flex items-center gap-3">
            <div class="chip rounded-xl p-2">
              <span class="text-xs opacity-80">kcal</span>
              <input id="ingKcal" type="number" min="0" step="1"
                     class="w-24 bg-transparent mono outline-none ml-2" placeholder="p.ej. 90" />
            </div>
            <button id="ingConsistenciaBtn" class="btn chip rounded-xl px-3 py-2 text-sm">
              üîç Buscar consistencia
            </button>
          </div>

          <div>
            <button id="addIngestaBtn" class="btn bg-sky-500 hover:opacity-90 rounded-xl px-4 py-2 text-sm font-semibold">
              Guardar ingesta
            </button>
          </div>
        </div>

        <!-- Lista -->
        <div class="chip rounded-xl p-3">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm opacity-80">Listado de hoy</span>
            <span class="text-xs opacity-70">Ingestas</span>
          </div>
          <ul id="ingestasList" class="space-y-2 max-h-64 overflow-auto"></ul>
        </div>
      </div>
    </section>

    <!-- Consumos -->
    <section class="glass rounded-2xl p-5 md:p-6 mb-6">
      <h3 class="text-lg font-semibold mb-3">üèÉ Nueva actividad (consumo)</h3>
      <div class="grid md:grid-cols-2 gap-4">
        <!-- Columna de entrada -->
        <div class="space-y-3">
          <div class="chip rounded-xl p-3">
            <label class="text-sm opacity-80">Descripci√≥n</label>
            <input id="conDesc" type="text" class="w-full bg-transparent outline-none"
              placeholder='Ej.: "correr 30 min", "caminar 1h", "clase de spinning"' />
          </div>

          <div class="flex items-center gap-3">
            <label class="btn chip rounded-xl px-3 py-2 cursor-pointer text-sm">
              üì∑ Adjuntar foto (opcional)
              <input id="conFile" type="file" accept="image/*" class="hidden-input" />
            </label>
            <button id="conAI" class="btn chip rounded-xl px-3 py-2 text-sm hover:opacity-90">
              ü§ñ Estimar con IA
            </button>
            <span id="conAIStatus" class="text-xs opacity-75"></span>
          </div>

          <div class="flex items-center gap-3">
            <div class="chip rounded-xl p-2">
              <span class="text-xs opacity-80">kcal</span>
              <input id="conKcal" type="number" min="0" step="1"
                     class="w-24 bg-transparent mono outline-none ml-2" placeholder="p.ej. 250" />
            </div>
          </div>

          <div>
            <button id="addConsumoBtn" class="btn bg-emerald-500 hover:opacity-90 rounded-xl px-4 py-2 text-sm font-semibold">
              Guardar consumo
            </button>
          </div>
        </div>

        <!-- Lista -->
        <div class="chip rounded-xl p-3">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm opacity-80">Listado de hoy</span>
            <span class="text-xs opacity-70">Consumos</span>
          </div>
          <ul id="consumosList" class="space-y-2 max-h-64 overflow-auto"></ul>
        </div>
      </div>
    </section>

    <!-- Pie -->
    <section class="grid md:grid-cols-2 gap-4">
      <div class="chip rounded-xl p-4 text-xs opacity-80">
        <b>Consejo:</b> Si ya has registrado ‚Äúcaf√© con leche = 90 kcal‚Äù, la pr√≥xima vez que lo escribas se autocompletar√°.
      </div>
      <div class="chip rounded-xl p-4 text-xs opacity-80">
        <b>Privacidad:</b> las fotos se usan solo para la estimaci√≥n de calor√≠as en el momento; no se suben a la base de datos.
      </div>
    </section>
  </main>

  <!-- Modal Ajustes -->
  <dialog id="settingsDlg" class="glass rounded-2xl p-0 w-[95vw] max-w-xl">
    <form method="dialog">
      <div class="p-5 md:p-6">
        <div class="flex items-center justify-between mb-4">
          <h4 class="text-lg font-semibold">Ajustes</h4>
          <button class="chip rounded-lg px-2 py-1">‚úñ</button>
        </div>

        <div class="space-y-4">
          <div class="chip rounded-xl p-3">
            <label class="block text-sm opacity-80 mb-1">Proxy URL (Firebase Function) ‚Äî recomendado</label>
            <input id="proxyUrlInput" type="text" class="w-full bg-transparent outline-none text-sm"
              placeholder="https://REGION-PROJECT.cloudfunctions.net/geminiGenerate" />
            <div class="text-xs opacity-70 mt-1">
              Si lo dejas vac√≠o, la app usar√° la API Key local (solo pruebas).
            </div>
          </div>

          <div class="chip rounded-xl p-3">
            <label class="block text-sm opacity-80 mb-1">Gemini API Key (solo pruebas en cliente)</label>
            <input id="geminiKeyInput" type="password" class="w-full bg-transparent outline-none text-sm"
              placeholder="AIza..." />
            <div class="text-xs opacity-70 mt-1">
              <b>No recomendado</b> para producci√≥n (expones tu clave). Usa el proxy cuando puedas.
            </div>
          </div>

          <div class="chip rounded-xl p-3">
            <label class="block text-sm opacity-80 mb-1">Objetivo kcal por d√≠a (meta)</label>
            <input id="metaDlgInput" type="number" min="0" step="10"
                   class="w-40 bg-transparent outline-none mono" />
          </div>
        </div>

        <div class="mt-5 flex justify-end gap-2">
          <button id="settingsSaveBtn" class="btn bg-sky-500 rounded-xl px-4 py-2 text-sm font-semibold">Guardar</button>
        </div>
      </div>
    </form>
  </dialog>

  <!-- Firebase SDK + App -->
  <script type="module">
    // -----------------------------
    // 1) Firebase bootstrapping
    // -----------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInAnonymously
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, query, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    // TODO: Pega tu config de Firebase aqu√≠:
   const firebaseConfig = {
  apiKey: "AIzaSyBbQMZ0lIrMvZ3r4DsbUFy22EMBJ6Zu3zM",
  authDomain: "caloriebuddy-48b3b.firebaseapp.com",
  projectId: "caloriebuddy-48b3b",
  storageBucket: "caloriebuddy-48b3b.appspot.com",
  messagingSenderId: "561415163751",
  appId: "1:561415163751:web:23049923151bfb0163a9c2"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Estado global sencillo
    let uid = null;
    let todayKey = getTodayKey(); // YYYY-MM-DD
    let metaKcal = 2000; // valor por defecto (se sobreescribe con los datos del usuario)
    // Cache local de consistencia base
    const foodCalorieLookup = {
      // Puedes ampliar esta tabla local. Se usa si no hay registro en Firestore.
      "caf√© con leche": 90,
      "manzana": 52,
      "pl√°tano": 89,
      "huevo": 78,
    };

    // -----------------------------
    // 2) Utilidades UI
    // -----------------------------
    const $ = (sel) => document.querySelector(sel);
    const uidSpan = $("#uidSpan");
    const todayLabel = $("#todayLabel");
    const ingestasList = $("#ingestasList");
    const consumosList = $("#consumosList");
    const ingDesc = $("#ingDesc");
    const ingFile = $("#ingFile");
    const ingKcal = $("#ingKcal");
    const ingAI = $("#ingAI");
    const ingAIStatus = $("#ingAIStatus");
    const ingConsistenciaBtn = $("#ingConsistenciaBtn");
    const addIngestaBtn = $("#addIngestaBtn");

    const conDesc = $("#conDesc");
    const conFile = $("#conFile");
    const conKcal = $("#conKcal");
    const conAI = $("#conAI");
    const conAIStatus = $("#conAIStatus");
    const addConsumoBtn = $("#addConsumoBtn");

    const ingestasTotal = $("#ingestasTotal");
    const consumosTotal = $("#consumosTotal");
    const balanceSpan = $("#balanceSpan");
    const metaInput = $("#metaInput");
    const saveMetaBtn = $("#saveMetaBtn");

    const settingsDlg = $("#settingsDlg");
    const openSettingsBtn = $("#openSettingsBtn");
    const settingsSaveBtn = $("#settingsSaveBtn");
    const proxyUrlInput = $("#proxyUrlInput");
    const geminiKeyInput = $("#geminiKeyInput");
    const metaDlgInput = $("#metaDlgInput");

    todayLabel.textContent = `(${todayKey})`;

    openSettingsBtn.addEventListener("click", () => {
      proxyUrlInput.value = localStorage.getItem("GEMINI_PROXY_URL") || "";
      geminiKeyInput.value = localStorage.getItem("GEMINI_API_KEY") || "";
      metaDlgInput.value = metaKcal;
      settingsDlg.showModal();
    });
    settingsSaveBtn.addEventListener("click", (e) => {
      e.preventDefault();
      localStorage.setItem("GEMINI_PROXY_URL", proxyUrlInput.value.trim());
      localStorage.setItem("GEMINI_API_KEY", geminiKeyInput.value.trim());
      const m = parseInt(metaDlgInput.value || "0", 10);
      if (!Number.isNaN(m) && m >= 0) {
        metaKcal = m;
        metaInput.value = m;
        saveUserMeta(m).catch(console.error);
        recomputeBalance();
      }
      settingsDlg.close();
    });

    metaInput.addEventListener("change", () => {
      const v = parseInt(metaInput.value || "0", 10);
      if (!Number.isNaN(v) && v >= 0) {
        metaKcal = v;
      }
    });
    saveMetaBtn.addEventListener("click", async () => {
      await saveUserMeta(metaKcal);
      alert("Meta guardada");
      recomputeBalance();
    });

    // -----------------------------
    // 3) Auth an√≥nima + carga inicial
    // -----------------------------
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        await signInAnonymously(auth);
        return;
      }
      uid = user.uid;
      uidSpan.textContent = uid.slice(0, 8) + "‚Ä¶";

      // Carga meta guardada si existe
      const uRef = doc(db, "users", uid);
      const uSnap = await getDoc(uRef);
      if (uSnap.exists()) {
        metaKcal = uSnap.data()?.metaKcal ?? metaKcal;
      }
      metaInput.value = metaKcal;

      // Cargar d√≠a
      await loadDay();
    });

    async function saveUserMeta(v) {
      if (!uid) return;
      const uRef = doc(db, "users", uid);
      await setDoc(uRef, { metaKcal: v }, { merge: true });
    }

    // -----------------------------
    // 4) Data model (Firestore)
    //    users/{uid}/days/{YYYY-MM-DD}/ingestas|consumos
    //    users/{uid}/knownItems/{slug} -> {descripcion, calorias}
    // -----------------------------
    async function loadDay() {
      if (!uid) return;

      // Ingestas
      const ingRef = collection(db, "users", uid, "days", todayKey, "ingestas");
      const ingQ = query(ingRef, orderBy("createdAt", "asc"));
      const ingSnap = await getDocs(ingQ);
      const ingestas = ingSnap.docs.map(d => ({ id: d.id, ...d.data() }));

      // Consumos
      const conRef = collection(db, "users", uid, "days", todayKey, "consumos");
      const conQ = query(conRef, orderBy("createdAt", "asc"));
      const conSnap = await getDocs(conQ);
      const consumos = conSnap.docs.map(d => ({ id: d.id, ...d.data() }));

      renderLists(ingestas, consumos);
      recomputeTotals(ingestas, consumos);
    }

    function renderLists(ingestas, consumos) {
      ingestasList.innerHTML = "";
      consumosList.innerHTML = "";

      for (const it of ingestas) {
        const li = document.createElement("li");
        li.className = "chip rounded-xl px-3 py-2 flex items-center justify-between text-sm";
        li.innerHTML = `
          <span>${escapeHtml(it.descripcion || "(sin descripci√≥n)")}</span>
          <span class="mono">${it.kcal ?? 0} kcal</span>
        `;
        ingestasList.appendChild(li);
      }

      for (const it of consumos) {
        const li = document.createElement("li");
        li.className = "chip rounded-xl px-3 py-2 flex items-center justify-between text-sm";
        li.innerHTML = `
          <span>${escapeHtml(it.descripcion || "(sin descripci√≥n)")}</span>
          <span class="mono">${it.kcal ?? 0} kcal</span>
        `;
        consumosList.appendChild(li);
      }
    }

    function recomputeTotals(ingestas, consumos) {
      const tIn = (ingestas || []).reduce((s, x) => s + (x.kcal || 0), 0);
      const tOut = (consumos || []).reduce((s, x) => s + (x.kcal || 0), 0);
      ingestasTotal.textContent = tIn;
      consumosTotal.textContent = tOut;
      recomputeBalance();
    }

    function recomputeBalance() {
      const inV = parseInt(ingestasTotal.textContent || "0", 10);
      const outV = parseInt(consumosTotal.textContent || "0", 10);
      const bal = inV - outV - metaKcal; // negativo => d√©ficit
      balanceSpan.textContent = bal;
      balanceSpan.classList.toggle("text-emerald-400", bal < 0);
      balanceSpan.classList.toggle("text-rose-400", bal >= 0);
    }

    async function addIngesta(descripcion, kcal) {
      if (!uid) return;
      const ref = collection(db, "users", uid, "days", todayKey, "ingestas");
      await addDoc(ref, {
        descripcion: descripcion?.trim() || "",
        kcal: Number(kcal) || 0,
        createdAt: serverTimestamp()
      });
      // guardar consistencia
      await saveKnownCalories(descripcion, Number(kcal) || 0);
      await loadDay();
    }

    async function addConsumo(descripcion, kcal) {
      if (!uid) return;
      const ref = collection(db, "users", uid, "days", todayKey, "consumos");
      await addDoc(ref, {
        descripcion: descripcion?.trim() || "",
        kcal: Number(kcal) || 0,
        createdAt: serverTimestamp()
      });
      await loadDay();
    }

    async function saveKnownCalories(descripcion, calorias) {
      if (!uid) return;
      const slug = slugify(descripcion);
      if (!slug) return;
      const kRef = doc(db, "users", uid, "knownItems", slug);
      await setDoc(kRef, { descripcion: slug, calorias: Number(calorias) || 0 }, { merge: true });
    }

    async function getKnownCalories(descripcion) {
      if (!uid) return null;
      const slug = slugify(descripcion);
      if (!slug) return null;

      // 1) Firestore
      const kRef = doc(db, "users", uid, "knownItems", slug);
      const kSnap = await getDoc(kRef);
      if (kSnap.exists()) return Number(kSnap.data()?.calorias) || 0;

      // 2) Tabla local
      if (foodCalorieLookup.hasOwnProperty(slug)) {
        return Number(foodCalorieLookup[slug]) || 0;
      }

      return null;
    }

    // -----------------------------
    // 5) IA (Gemini) con proxy o key local
    // -----------------------------
    ingAI.addEventListener("click", () => handleAIFor("ingesta"));
    conAI.addEventListener("click", () => handleAIFor("consumo"));

    async function handleAIFor(kind) {
      // kind: "ingesta" | "consumo"
      const isIngesta = kind === "ingesta";
      const descEl = isIngesta ? ingDesc : conDesc;
      const fileEl = isIngesta ? ingFile : conFile;
      const statusEl = isIngesta ? ingAIStatus : conAIStatus;
      const kcalEl = isIngesta ? ingKcal : conKcal;

      const desc = (descEl.value || "").trim();
      const file = fileEl.files?.[0] || null;

      // Si es ingesta y tenemos consistencia previa, √∫sala primero:
      if (isIngesta && desc) {
        const known = await getKnownCalories(desc);
        if (known !== null) {
          kcalEl.value = known;
          statusEl.textContent = "‚úîÔ∏è Consistencia aplicada (Firestore/tabla local)";
          return;
        }
      }

      statusEl.textContent = "Analizando con IA‚Ä¶";
      try {
        let base64 = null, mime = null;
        if (file) {
          const { data, mimeType } = await fileToBase64(file);
          base64 = data; mime = mimeType;
        }

        const estimate = await estimateCaloriesViaAI(kind, desc, base64, mime);
        // estimate: { kcal, item, notes? }
        if (estimate?.kcal != null) {
          kcalEl.value = Math.round(Number(estimate.kcal));
          statusEl.textContent = "‚úÖ IA OK";
          if (isIngesta && desc && estimate.kcal) {
            await saveKnownCalories(desc, Number(estimate.kcal));
          }
        } else {
          statusEl.textContent = "‚ö†Ô∏è IA no devolvi√≥ kcal";
        }
      } catch (e) {
        console.error(e);
        statusEl.textContent = "‚ùå Error IA";
        alert("Error consultando IA: " + (e?.message || e));
      }
    }

    async function estimateCaloriesViaAI(kind, description, base64Data, mimeType) {
      // Prompt adaptado: pide SOLO JSON {kcal: number, item: string, notes?: string}
      // - kind: ingesta -> calor√≠as ingeridas
      // - consumo -> calor√≠as gastadas
      const prefix = kind === "ingesta"
        ? "Eres un nutricionista. Estima las calor√≠as ingeridas totales del alimento/comida descrita."
        : "Eres un entrenador. Estima las calor√≠as consumidas (gastadas) en la actividad descrita.";

      const guidance =
        "Devuelve SOLO JSON con la forma {\"kcal\": number, \"item\": string, \"notes\": string}." +
        " Usa la foto como apoyo si existe. Si hay texto del tipo 'un caf√© con leche usando esta leche de la foto'," +
        " combina ambos inputs. Si faltan datos, haz una estimaci√≥n razonable. No incluyas nada que no sea JSON.";

      const userText = [
        prefix,
        description ? `Descripci√≥n: ${description}` : "",
        guidance
      ].filter(Boolean).join("\n");

      // Construimos payload Gemini
      const parts = [{ text: userText }];
      if (base64Data && mimeType) {
        parts.push({ inlineData: { mimeType, data: base64Data } });
      }
      const payload = {
        contents: [{ role: "user", parts }],
        generationConfig: { responseMimeType: "application/json" }
      };

      const proxyUrl = (localStorage.getItem("GEMINI_PROXY_URL") || "").trim();
      let raw;
      if (proxyUrl) {
        // Ruta recomendada: tu Firebase Function (no expone API key)
        const r = await fetch(proxyUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ payload })
        });
        const j = await r.json();
        // Esperamos {text: "‚Ä¶"} o bien {candidates:‚Ä¶} seg√∫n tu funci√≥n
        raw = typeof j?.text === "string" ? j.text : JSON.stringify(j);
      } else {
        // Ruta de pruebas: llamada directa con API Key del cliente (menos seguro)
        const apiKey = (localStorage.getItem("GEMINI_API_KEY") || "").trim();
        if (!apiKey) throw new Error("Falta API Key o Proxy URL (abre Ajustes).");
        const url =
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${encodeURIComponent(apiKey)}`;
        const r = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        raw = j?.candidates?.[0]?.content?.parts?.[0]?.text || "";
      }

      const json = extractJson(raw);
      if (!json) throw new Error("La IA no devolvi√≥ JSON usable.");
      return json;
    }

    // -----------------------------
    // 6) Interacciones principales
    // -----------------------------
    ingConsistenciaBtn.addEventListener("click", async () => {
      const d = (ingDesc.value || "").trim();
      if (!d) return alert("Escribe una descripci√≥n primero.");
      const known = await getKnownCalories(d);
      if (known !== null) {
        ingKcal.value = known;
        ingAIStatus.textContent = "‚úîÔ∏è Consistencia aplicada";
      } else {
        ingAIStatus.textContent = "‚ÑπÔ∏è Sin consistencia; prueba IA";
      }
    });

    addIngestaBtn.addEventListener("click", async () => {
      const d = (ingDesc.value || "").trim();
      const k = parseInt(ingKcal.value || "0", 10);
      if (!d) return alert("Escribe una descripci√≥n.");
      if (Number.isNaN(k) || k <= 0) return alert("Indica kcal v√°lidas (>0).");
      await addIngesta(d, k);
      ingDesc.value = ""; ingKcal.value = ""; ingFile.value = "";
      ingAIStatus.textContent = "";
    });

    addConsumoBtn.addEventListener("click", async () => {
      const d = (conDesc.value || "").trim();
      const k = parseInt(conKcal.value || "0", 10);
      if (!d) return alert("Escribe una descripci√≥n.");
      if (Number.isNaN(k) || k <= 0) return alert("Indica kcal v√°lidas (>0).");
      await addConsumo(d, k);
      conDesc.value = ""; conKcal.value = ""; conFile.value = "";
      conAIStatus.textContent = "";
    });

    // -----------------------------
    // 7) Helpers
    // -----------------------------
    function getTodayKey() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, "0");
      const d = String(now.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function escapeHtml(s = "") {
      return s.replace(/[&<>"']/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;" }[c]));
    }

    function slugify(s = "") {
      return s
        .toLowerCase()
        .normalize("NFD").replace(/\p{Diacritic}/gu, "")
        .replace(/[^a-z0-9\s]/g, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => {
          const res = String(fr.result || "");
          // data:<mime>;base64,XXXX
          const m = res.match(/^data:(.+?);base64,(.*)$/);
          if (!m) return reject(new Error("No se pudo leer el archivo."));
          resolve({ mimeType: m[1], data: m[2] });
        };
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    function extractJson(text) {
      if (!text) return null;
      // Maneja casos con ```json ... ```
      const fence = text.match(/```json\s*([\s\S]*?)```/i);
      let raw = fence ? fence[1] : text;
      raw = raw.trim();

      // Si hay texto extra, intenta recortar al primer y √∫ltimo { }
      const first = raw.indexOf("{");
      const last = raw.lastIndexOf("}");
      if (first !== -1 && last !== -1 && last > first) {
        raw = raw.slice(first, last + 1);
      }

      try {
        const j = JSON.parse(raw);
        return j;
      } catch {
        return null;
      }
    }
  </script>
</body>
</html>

