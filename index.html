<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CalorieBuddy ¬∑ Diario</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body{min-height:100vh;background:#0b1324;color:#eaeef7}
  .card{background:#101a33;border:1px solid #223257;border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
  .chip{background:#152241;border:1px solid #2b3e69}
  .btn{transition:transform .05s ease,opacity .2s ease} .btn:active{transform:translateY(1px)}
  .btn[disabled]{opacity:.5; cursor:not-allowed}
  .mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,Menlo,monospace}
  input[type="file"]{display:none}
</style>
</head>
<body class="antialiased">
<header class="max-w-4xl mx-auto px-4 py-5 flex items-center justify-between">
  <h1 class="text-xl font-semibold">ü•ó CalorieBuddy</h1>
  <div class="flex items-center gap-2">
    <button id="openBmrBtn" class="btn chip px-3 py-2 rounded-xl text-sm">üßÆ BMR</button>
    <button id="openSettingsBtn" class="btn chip px-3 py-2 rounded-xl text-sm">‚öôÔ∏è Ajustes</button>
    <span class="chip text-xs px-3 py-2 rounded-xl">UID: <b id="uidSpan">‚Äî</b></span>
  </div>
</header>

<main class="max-w-4xl mx-auto px-4 pb-24 space-y-6">
  <!-- Resumen -->
  <section class="card p-4">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
      <div class="chip rounded-xl p-3">
        <div class="text-xs opacity-80">Ingestas</div>
        <div id="ingestasTotal" class="text-2xl mono">0</div>
      </div>
      <div class="chip rounded-xl p-3">
        <div class="text-xs opacity-80">Consumos</div>
        <div id="consumosTotal" class="text-2xl mono">0</div>
      </div>
      <div class="chip rounded-xl p-3">
        <div class="text-xs opacity-80">BMR (kcal)</div>
        <div class="flex items-end gap-2">
          <input id="metaInput" type="number" min="0" step="10" value="2000" class="bg-transparent mono outline-none w-24">
          <button id="saveMetaBtn" class="btn chip rounded-md px-2 py-1 text-xs">Guardar</button>
        </div>
      </div>
      <div class="chip rounded-xl p-3">
        <div class="text-xs opacity-80">Balance <span id="todayLabel" class="opacity-70"></span></div>
        <div id="balanceSpan" class="text-2xl mono">0</div>
        <div class="text-xs opacity-70">negativo = d√©ficit</div>
      </div>
    </div>
  </section>

  <!-- Ingesta -->
  <section class="card p-4">
    <h2 class="font-semibold mb-3">‚ûï Nueva ingesta</h2>
    <div class="grid md:grid-cols-2 gap-4">
      <div class="space-y-3">
        <div class="chip rounded-xl p-3">
          <label class="text-sm opacity-80">Descripci√≥n</label>
          <input id="ingDesc" class="w-full bg-transparent outline-none" placeholder='p.ej. "huevo frito con patatas"'>
        </div>
        <div class="flex items-center gap-3 flex-wrap">
          <label class="btn chip rounded-xl px-3 py-2 text-sm cursor-pointer">üì∑ Adjuntar foto
            <input id="ingFile" type="file" accept="image/*">
          </label>
          <img id="ingPreview" class="h-12 rounded-lg hidden" alt="preview">
          <span id="ingPhotoChip" class="chip text-xs px-2 py-1 rounded-lg hidden" title="La foto se ha cargado correctamente">üì∑ Lista</span>
          <span id="ingIaChip" class="chip text-xs px-2 py-1 rounded-lg hidden" title="La IA ya estim√≥ las kcal">ü§ñ IA OK</span>
          <button id="ingAI" class="btn chip rounded-xl px-3 py-2 text-sm">ü§ñ Calcular con IA</button>
          <span id="ingAIStatus" class="text-xs opacity-75"></span>
        </div>
        <div class="flex items-center gap-3">
          <div class="chip rounded-xl p-2">
            <span class="text-xs opacity-80">kcal</span>
            <input id="ingKcal" type="number" min="0" class="w-24 bg-transparent mono outline-none ml-2" placeholder="90">
          </div>
          <button id="ingConsistenciaBtn" class="btn chip rounded-xl px-3 py-2 text-sm">üîç Consistencia</button>
        </div>
        <div class="flex items-center gap-2">
          <button id="addIngestaBtn" class="btn bg-sky-500 rounded-xl px-4 py-2 text-sm font-semibold hover:opacity-90" disabled>
            Guardar ingesta
          </button>
          <button id="clearIngestaBtn" class="btn chip rounded-xl px-3 py-2 text-sm" title="Vaciar campos no guardados">
            üßπ Limpiar
          </button>
        </div>
      </div>

      <div class="chip rounded-xl p-3">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm opacity-80">Listado de hoy</span>
          <span class="text-xs opacity-60">Ingestas</span>
        </div>
        <ul id="ingestasList" class="space-y-2 max-h-64 overflow-auto"></ul>
      </div>
    </div>
  </section>

  <!-- Consumo -->
  <section class="card p-4">
    <h2 class="font-semibold mb-3">üèÉ Nueva actividad (consumo)</h2>
    <div class="grid md:grid-cols-2 gap-4">
      <div class="space-y-3">
        <div class="chip rounded-xl p-3">
          <label class="text-sm opacity-80">Descripci√≥n</label>
          <input id="conDesc" class="w-full bg-transparent outline-none" placeholder='p.ej. "correr 30 min"'>
        </div>
        <div class="flex items-center gap-3 flex-wrap">
          <label class="btn chip rounded-xl px-3 py-2 text-sm cursor-pointer">üì∑ Adjuntar foto (opcional)
            <input id="conFile" type="file" accept="image/*">
          </label>
          <img id="conPreview" class="h-12 rounded-lg hidden" alt="preview">
          <span id="conPhotoChip" class="chip text-xs px-2 py-1 rounded-lg hidden" title="La foto se ha cargado correctamente">üì∑ Lista</span>
          <span id="conIaChip" class="chip text-xs px-2 py-1 rounded-lg hidden" title="La IA ya estim√≥ las kcal">ü§ñ IA OK</span>
          <button id="conAI" class="btn chip rounded-xl px-3 py-2 text-sm">ü§ñ Estimar con IA</button>
          <span id="conAIStatus" class="text-xs opacity-75"></span>
        </div>
        <div class="flex items-center gap-3">
          <div class="chip rounded-xl p-2">
            <span class="text-xs opacity-80">kcal</span>
            <input id="conKcal" type="number" min="0" class="w-24 bg-transparent mono outline-none ml-2" placeholder="250">
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button id="addConsumoBtn" class="btn bg-emerald-500 rounded-xl px-4 py-2 text-sm font-semibold hover:opacity-90" disabled>
            Guardar consumo
          </button>
          <button id="clearConsumoBtn" class="btn chip rounded-xl px-3 py-2 text-sm" title="Vaciar campos no guardados">
            üßπ Limpiar
          </button>
        </div>
      </div>

      <div class="chip rounded-xl p-3">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm opacity-80">Listado de hoy</span>
          <span class="text-xs opacity-60">Consumos</span>
        </div>
        <ul id="consumosList" class="space-y-2 max-h-64 overflow-auto"></ul>
      </div>
    </div>
  </section>

  <!-- Historial -->
  <section class="card p-4">
    <h2 class="font-semibold mb-3">üìÖ Historial (√∫ltimos 14 d√≠as)</h2>
    <ul id="historyList" class="space-y-1"></ul>
  </section>
</main>

<!-- Ajustes -->
<dialog id="settingsDlg" class="card p-0 w-[95vw] max-w-xl">
  <form method="dialog">
    <div class="p-5">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">Ajustes</h3>
        <button class="chip px-2 py-1 rounded-lg">‚úñ</button>
      </div>

      <div class="space-y-4">
        <div class="chip rounded-xl p-3">
          <label class="block text-sm opacity-80 mb-1">Proxy URL (Firebase Function)</label>
          <input id="proxyUrlInput" class="w-full bg-transparent outline-none text-sm"
                 placeholder="https://REGION-PROYECTO.cloudfunctions.net/geminiGenerate">
          <p class="text-xs opacity-70 mt-1">Si lo dejas vac√≠o, se usa el fallback por defecto.</p>
        </div>
        <div class="chip rounded-xl p-3">
          <label class="block text-sm opacity-80 mb-1">BMR (kcal)</label>
          <input id="metaDlgInput" type="number" min="0" step="10" class="bg-transparent outline-none w-32">
        </div>
      </div>

      <div class="mt-4 flex justify-end">
        <button id="settingsSaveBtn" class="btn bg-sky-500 rounded-xl px-4 py-2 text-sm font-semibold">Guardar</button>
      </div>
    </div>
  </form>
</dialog>

<!-- BMR -->
<dialog id="bmrDlg" class="card p-0 w-[95vw] max-w-md">
  <form method="dialog">
    <div class="p-5 space-y-4">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Calcular BMR</h3>
        <button class="chip px-2 py-1 rounded-lg">‚úñ</button>
      </div>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="chip rounded-xl p-3">
          <label class="text-xs opacity-80">Sexo</label>
          <select id="bmrSex" class="bg-transparent outline-none w-full">
            <option value="male">Hombre</option>
            <option value="female">Mujer</option>
          </select>
        </div>
        <div class="chip rounded-xl p-3">
          <label class="text-xs opacity-80">Peso (kg)</label>
          <input id="bmrWeight" type="number" min="20" step="0.1" class="bg-transparent outline-none w-full" placeholder="70">
        </div>
        <div class="chip rounded-xl p-3">
          <label class="text-xs opacity-80">Altura (cm)</label>
          <input id="bmrHeight" type="number" min="120" step="1" class="bg-transparent outline-none w-full" placeholder="175">
        </div>
        <div class="chip rounded-xl p-3">
          <label class="text-xs opacity-80">Edad (a√±os)</label>
          <input id="bmrAge" type="number" min="10" step="1" class="bg-transparent outline-none w-full" placeholder="30">
        </div>
      </div>
      <div class="text-xs opacity-70">Mifflin-St Jeor: Hombre (+5) ¬∑ Mujer (‚àí161).</div>
      <div class="flex justify-end gap-2">
        <button id="bmrCalcBtn" class="btn bg-emerald-500 rounded-xl px-4 py-2 text-sm font-semibold">Calcular y aplicar</button>
      </div>
    </div>
  </form>
</dialog>

<!-- ===================== -->
<!--  SCRIPT PRINCIPAL     -->
<!-- ===================== -->
<script type="module">
  /* Firebase por CDN */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs,
    query, orderBy, serverTimestamp, updateDoc, deleteDoc
  } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

  // Config de TU proyecto
const firebaseConfig = {
  apiKey: "AIzaSyBbQMzOlIrMvZ3r4DsbUFy22EMBJ6Zu3zM",
  authDomain: "caloriebuddy-48b3b.firebaseapp.com",
  projectId: "caloriebuddy-48b3b",
  storageBucket: "caloriebuddy-48b3b.appspot.com",
  messagingSenderId: "561415163751",
  appId: "1:561415163751:web:23049923151bfb0163a9c2"
};

  const DEFAULT_PROXY_URL = "https://europe-west1-caloriebuddy-48b3b.cloudfunctions.net/geminiGenerate";

  // ---------- Estado/UI ----------
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  const $ = (s)=>document.querySelector(s);
  const uidSpan=$("#uidSpan"), todayLabel=$("#todayLabel");
  const ingestasList=$("#ingestasList"), consumosList=$("#consumosList");
  const ingDesc=$("#ingDesc"), ingFile=$("#ingFile"), ingPreview=$("#ingPreview");
  const ingKcal=$("#ingKcal"), ingAI=$("#ingAI"), ingAIStatus=$("#ingAIStatus");
  const ingPhotoChip=$("#ingPhotoChip"), ingIaChip=$("#ingIaChip");
  const ingConsistenciaBtn=$("#ingConsistenciaBtn"), addIngestaBtn=$("#addIngestaBtn"), clearIngestaBtn=$("#clearIngestaBtn");
  const conDesc=$("#conDesc"), conFile=$("#conFile"), conPreview=$("#conPreview");
  const conKcal=$("#conKcal"), conAI=$("#conAI"), conAIStatus=$("#conAIStatus");
  const conPhotoChip=$("#conPhotoChip"), conIaChip=$("#conIaChip");
  const addConsumoBtn=$("#addConsumoBtn"), clearConsumoBtn=$("#clearConsumoBtn");
  const ingestasTotal=$("#ingestasTotal"), consumosTotal=$("#consumosTotal"), balanceSpan=$("#balanceSpan");
  const metaInput=$("#metaInput"), saveMetaBtn=$("#saveMetaBtn");
  const openSettingsBtn=$("#openSettingsBtn"), settingsDlg=$("#settingsDlg"), settingsSaveBtn=$("#settingsSaveBtn"), proxyUrlInput=$("#proxyUrlInput"), metaDlgInput=$("#metaDlgInput");
  const openBmrBtn=$("#openBmrBtn"), bmrDlg=$("#bmrDlg"), bmrCalcBtn=$("#bmrCalcBtn");
  const bmrSex=$("#bmrSex"), bmrWeight=$("#bmrWeight"), bmrHeight=$("#bmrHeight"), bmrAge=$("#bmrAge");
  const historyList=$("#historyList");

  let uid=null, metaKcal=2000;
  const todayKey=getTodayKey(); if(todayLabel) todayLabel.textContent=`(${todayKey})`;

  const foodCalorieLookup={ "caf√© con leche":90, "manzana":52, "pl√°tano":89, "huevo frito":196 };

  // ---------- Ajustes ----------
  openSettingsBtn?.addEventListener("click",()=>{
    proxyUrlInput.value = localStorage.getItem("GEMINI_PROXY_URL") || "";
    metaDlgInput.value = metaKcal;
    settingsDlg.showModal();
  });
  settingsSaveBtn?.addEventListener("click",(e)=>{
    e.preventDefault();
    localStorage.setItem("GEMINI_PROXY_URL", proxyUrlInput.value.trim());
    const m = parseInt(metaDlgInput.value || "0", 10);
    if (!Number.isNaN(m) && m >= 0) {
      metaKcal = m; metaInput.value = m; saveUserMeta(m).catch(console.error); recomputeBalance(); writeTodaySummaryFromUI().catch(console.error);
    }
    settingsDlg.close();
  });

  metaInput?.addEventListener("change", () => {
    const v = parseInt(metaInput.value || "0", 10);
    if (!Number.isNaN(v) && v >= 0) metaKcal = v;
  });
  saveMetaBtn?.addEventListener("click", async () => {
    await saveUserMeta(metaKcal);
    alert("BMR guardado");
    recomputeBalance();
    await writeTodaySummaryFromUI();
  });

  // ---------- BMR ----------
  openBmrBtn?.addEventListener("click", ()=>{
    bmrSex.value    = localStorage.getItem("BMR_S") || "male";
    bmrWeight.value = localStorage.getItem("BMR_W") || "";
    bmrHeight.value = localStorage.getItem("BMR_H") || "";
    bmrAge.value    = localStorage.getItem("BMR_A") || "";
    bmrDlg.showModal();
  });

  bmrCalcBtn?.addEventListener("click",(e)=>{
    e.preventDefault();
    const sex=(bmrSex.value||"male");
    const w=parseFloat(bmrWeight.value||"0"), h=parseFloat(bmrHeight.value||"0"), a=parseInt(bmrAge.value||"0",10);
    if(!(w>0&&h>0&&a>0)){ alert("Completa sexo, peso, altura y edad"); return; }
    const offset = sex==="female" ? -161 : 5; // Mifflin-St Jeor
    const bmr = Math.round(10*w + 6.25*h - 5*a + offset);
    metaKcal = bmr;
    metaInput.value = bmr;
    localStorage.setItem("BMR_S", sex);
    localStorage.setItem("BMR_W", w);
    localStorage.setItem("BMR_H", h);
    localStorage.setItem("BMR_A", a);
    saveUserMeta(bmr).catch(console.error);
    recomputeBalance();
    writeTodaySummaryFromUI().catch(console.error);
    bmrDlg.close();
  });

  // ---------- Auth + carga ----------
  onAuthStateChanged(auth, async (user) => {
    if (!user) { try { await signInAnonymously(auth); } catch (e) { alert("Auth error: " + e.message); } return; }
    uid = user.uid;
    uidSpan&&(uidSpan.textContent=uid.slice(0,8)+"‚Ä¶");
    const uRef = doc(db,"users",uid); const uSnap=await getDoc(uRef);
    if(uSnap.exists()) metaKcal=uSnap.data().metaKcal ?? metaKcal;
    metaInput&&(metaInput.value=metaKcal);
    await loadDay();
    await loadHistory();
  });

  async function saveUserMeta(v){ if(!uid) return; await setDoc(doc(db,"users",uid),{metaKcal:Number(v)||0},{merge:true}); }

  // ---------- Carga d√≠a ----------
  async function loadDay(){
    if(!uid) return;
    const ingRef=collection(db,"users",uid,"days",todayKey,"ingestas");
    const conRef=collection(db,"users",uid,"days",todayKey,"consumos");
    const [ingSnap,conSnap]=await Promise.all([
      getDocs(query(ingRef, orderBy("createdAt","asc"))),
      getDocs(query(conRef, orderBy("createdAt","asc")))
    ]);
    const ingestas=ingSnap.docs.map(d=>({id:d.id,...d.data()}));
    const consumos=conSnap.docs.map(d=>({id:d.id,...d.data()}));
    renderList(ingestasList, ingestas, "ingestas");
    renderList(consumosList, consumos, "consumos");
    await recomputeTotalsAndPersist(ingestas, consumos);
    refreshIngestaCTA();
    refreshConsumoCTA();
    await loadHistory();
  }

  function renderList(container, items, coll){
    if(!container) return; container.innerHTML="";
    (items||[]).forEach(it=>{
      const li=document.createElement("li");
      li.className="chip rounded-xl px-3 py-2 flex items-center justify-between text-sm";
      li.dataset.id=it.id; li.dataset.coll=coll; li.dataset.desc=it.descripcion||""; li.dataset.kcal=it.kcal||0;
      li.innerHTML=`<span>${escapeHtml(it.descripcion||"(sin descripci√≥n)")}</span>
        <div class="flex items-center gap-2">
          <span class="mono">${it.kcal||0} kcal</span>
          <button class="chip px-2 py-1 rounded-md text-xs" data-action="edit" title="Editar">‚úèÔ∏è</button>
          <button class="chip px-2 py-1 rounded-md text-xs" data-action="del" title="Borrar">üóëÔ∏è</button>
        </div>`;
      container.appendChild(li);
    });
  }

  async function recomputeTotalsAndPersist(ingestas, consumos){
    const tIn=(ingestas||[]).reduce((s,x)=>s+(x.kcal||0),0);
    const tOut=(consumos||[]).reduce((s,x)=>s+(x.kcal||0),0);
    ingestasTotal&&(ingestasTotal.textContent=tIn);
    consumosTotal&&(consumosTotal.textContent=tOut);
    recomputeBalance();
    if(uid){
      const dayDoc = doc(db,"users",uid,"days",todayKey);
      await setDoc(dayDoc,{
        meta: metaKcal,
        totals:{ingestas:tIn, consumos:tOut, balance:(tIn - tOut - metaKcal)},
        updatedAt: serverTimestamp()
      },{merge:true});
    }
  }

  function recomputeBalance(){
    const inV=parseInt(ingestasTotal?.textContent||"0",10)||0;
    const outV=parseInt(consumosTotal?.textContent||"0",10)||0;
    const bal=inV - outV - metaKcal;
    if(balanceSpan){
      balanceSpan.textContent=bal;
      balanceSpan.classList.toggle("text-emerald-400",bal<0);
      balanceSpan.classList.toggle("text-rose-400",bal>=0);
    }
  }

  async function writeTodaySummaryFromUI(){
    const tIn=parseInt(ingestasTotal?.textContent||"0",10)||0;
    const tOut=parseInt(consumosTotal?.textContent||"0",10)||0;
    if(uid){
      await setDoc(doc(db,"users",uid,"days",todayKey),{
        meta: metaKcal,
        totals:{ ingestas:tIn, consumos:tOut, balance:(tIn - tOut - metaKcal) },
        updatedAt: serverTimestamp()
      },{merge:true});
    }
  }

  // ---------- Guardar filas ----------
  addIngestaBtn?.addEventListener("click", async ()=>{
    const d=(ingDesc?.value||"").trim(); const k=parseInt(ingKcal?.value||"0",10);
    if(!d) return alert("Escribe descripci√≥n");
    if(Number.isNaN(k)||k<=0) return alert("Indica kcal v√°lidas");
    await addDoc(collection(db,"users",uid,"days",todayKey,"ingestas"),{ descripcion:d,kcal:k,createdAt:serverTimestamp() });
    await saveKnownCalories(d,k);
    clearIngestaFields();
    refreshIngestaCTA(); await loadDay();
  });

  addConsumoBtn?.addEventListener("click", async ()=>{
    const d=(conDesc?.value||"").trim(); const k=parseInt(conKcal?.value||"0",10);
    if(!d) return alert("Escribe descripci√≥n");
    if(Number.isNaN(k)||k<=0) return alert("Indica kcal v√°lidas");
    await addDoc(collection(db,"users",uid,"days",todayKey,"consumos"),{ descripcion:d,kcal:k,createdAt:serverTimestamp() });
    clearConsumoFields();
    refreshConsumoCTA(); await loadDay();
  });

  // ---------- NUEVO: Limpiar campos no guardados ----------
  clearIngestaBtn?.addEventListener("click", ()=>{
    clearIngestaFields();
    refreshIngestaCTA();
  });
  clearConsumoBtn?.addEventListener("click", ()=>{
    clearConsumoFields();
    refreshConsumoCTA();
  });

  function clearIngestaFields(){
    if(ingDesc) ingDesc.value="";
    if(ingKcal) ingKcal.value="";
    if(ingFile) ingFile.value="";
    if(ingAIStatus) ingAIStatus.textContent="";
    ingIaChip?.classList.add("hidden");
    ingPhotoChip?.classList.add("hidden");
    ingPreview?.classList.add("hidden");
  }
  function clearConsumoFields(){
    if(conDesc) conDesc.value="";
    if(conKcal) conKcal.value="";
    if(conFile) conFile.value="";
    if(conAIStatus) conAIStatus.textContent="";
    conIaChip?.classList.add("hidden");
    conPhotoChip?.classList.add("hidden");
    conPreview?.classList.add("hidden");
  }

  // ---------- Editar / Borrar ----------
  ingestasList?.addEventListener("click",onRowAction);
  consumosList?.addEventListener("click",onRowAction);
  async function onRowAction(ev){
    const btn=ev.target.closest("button[data-action]"); if(!btn) return;
    const li=btn.closest("li"); const id=li?.dataset?.id; const coll=li?.dataset?.coll;
    if(!id||!coll) return;
    const ref=doc(db,"users",uid,"days",todayKey,coll,id);
    if(btn.dataset.action==="del"){
      if(confirm("¬øBorrar elemento?")){ await deleteDoc(ref); await loadDay(); }
      return;
    }
    if(btn.dataset.action==="edit"){
      const curDesc=li.dataset.desc||""; const curKcal=li.dataset.kcal||"0";
      const newDesc=prompt("Descripci√≥n:",curDesc); if(newDesc===null) return;
      const newKcalStr=prompt("kcal:",curKcal); if(newKcalStr===null) return;
      const newKcal=parseInt(newKcalStr,10); if(Number.isNaN(newKcal)||newKcal<=0){ alert("kcal inv√°lidas"); return; }
      await updateDoc(ref,{ descripcion:newDesc, kcal:newKcal }); await loadDay();
    }
  }

  // ---------- Consistencia ----------
  ingConsistenciaBtn?.addEventListener("click", async ()=>{
    const d=(ingDesc?.value||"").trim(); if(!d) return;
    const known=await getKnownCalories(d);
    if(known!==null){ ingKcal.value=known; ingAIStatus.textContent="‚úîÔ∏è Consistencia"; refreshIngestaCTA(); }
    else { ingAIStatus.textContent="‚ÑπÔ∏è Sin consistencia"; }
  });
  async function saveKnownCalories(desc,kcal){
    if(!uid) return; const slug=slugify(desc); if(!slug) return;
    await setDoc(doc(db,"users",uid,"knownItems",slug),{ descripcion:slug, calorias:Number(kcal)||0 },{merge:true});
  }
  async function getKnownCalories(desc){
    if(!uid) return null; const slug=slugify(desc); if(!slug) return null;
    const ref=doc(db,"users",uid,"knownItems",slug); const s=await getDoc(ref);
    if(s.exists()) return Number(s.data().calorias)||0;
    if(Object.prototype.hasOwnProperty.call(foodCalorieLookup,slug)) return Number(foodCalorieLookup[slug])||0;
    return null;
  }

  // ---------- Foto: preview + autodescripci√≥n + kcal autom√°tica ----------
  ingFile?.addEventListener("change", async ()=>{
    const f=ingFile.files?.[0]; if(!f) return;
    ingPreview.src=URL.createObjectURL(f); ingPreview.classList.remove("hidden");
    ingPhotoChip.classList.remove("hidden"); ingIaChip.classList.add("hidden");
    ingAIStatus.textContent="üì∑ Analizando foto‚Ä¶";
    try{
      const b=await fileToBase64(f);
      const autoDesc=await describeImage(b.data,b.mimeType,"la comida de la foto");
      if(autoDesc){ ingDesc.value=autoDesc; ingAIStatus.textContent="üìù Descripci√≥n generada"; }
      const known=autoDesc ? await getKnownCalories(autoDesc) : null;
      if(known!==null){ ingKcal.value=known; ingAIStatus.textContent="‚úîÔ∏è Consistencia aplicada"; ingIaChip.classList.remove("hidden"); refreshIngestaCTA(); await writeTodaySummaryFromUI(); return; }
      ingAIStatus.textContent="ü§ñ Estimando kcal‚Ä¶";
      const out=await estimateCaloriesViaAI("ingesta", autoDesc||"", b.data, b.mimeType);
      if(out?.kcal!=null){ ingKcal.value=Math.round(Number(out.kcal)); ingAIStatus.textContent="‚úÖ IA OK"; ingIaChip.classList.remove("hidden"); }
      else { ingAIStatus.textContent="‚ö†Ô∏è IA no devolvi√≥ kcal"; }
    }catch(e){ console.error(e); ingAIStatus.textContent="‚ùå Error al analizar foto"; }
    refreshIngestaCTA(); await writeTodaySummaryFromUI();
  });

  conFile?.addEventListener("change", async ()=>{
    const f=conFile.files?.[0]; if(!f) return;
    conPreview.src=URL.createObjectURL(f); conPreview.classList.remove("hidden");
    conPhotoChip.classList.remove("hidden"); conIaChip.classList.add("hidden");
    conAIStatus.textContent="üì∑ Analizando foto‚Ä¶";
    try{
      const b=await fileToBase64(f);
      const autoDesc=await describeImage(b.data,b.mimeType,"la actividad/entorno de la imagen");
      if(autoDesc){ conDesc.value=autoDesc; conAIStatus.textContent="üìù Descripci√≥n generada"; }
      conAIStatus.textContent="ü§ñ Estimando kcal‚Ä¶";
      const out=await estimateCaloriesViaAI("consumo", autoDesc||"", b.data, b.mimeType);
      if(out?.kcal!=null){ conKcal.value=Math.round(Number(out.kcal)); conAIStatus.textContent="‚úÖ IA OK"; conIaChip.classList.remove("hidden"); }
      else { conAIStatus.textContent="‚ö†Ô∏è IA no devolvi√≥ kcal"; }
    }catch(e){ console.error(e); conAIStatus.textContent="‚ùå Error al analizar foto"; }
    refreshConsumoCTA(); await writeTodaySummaryFromUI();
  });

  // ---------- IA por proxy ----------
  ingAI?.addEventListener("click",()=>handleAI("ingesta"));
  conAI?.addEventListener("click",()=>handleAI("consumo"));

  async function handleAI(kind){
    const isIngesta=kind==="ingesta";
    const descEl=isIngesta?ingDesc:conDesc;
    const fileEl=isIngesta?ingFile:conFile;
    const statusEl=isIngesta?ingAIStatus:conAIStatus;
    const kcalEl=isIngesta?ingKcal:conKcal;
    const iaChip=isIngesta?ingIaChip:conIaChip;

    const desc=(descEl?.value||"").trim();
    const file=fileEl?.files?.[0]||null;

    if(isIngesta && desc){
      const known=await getKnownCalories(desc);
      if(known!==null){ kcalEl.value=known; statusEl.textContent="‚úîÔ∏è Consistencia"; iaChip.classList.remove("hidden"); refreshIngestaCTA(); await writeTodaySummaryFromUI(); return; }
    }

    statusEl.textContent="Analizando‚Ä¶";
    try{
      let base64=null,mime=null;
      if(file){ const r=await fileToBase64(file); base64=r.data; mime=r.mimeType; }
      const out=await estimateCaloriesViaAI(kind,desc,base64,mime);
      if(out?.kcal!=null){ kcalEl.value=Math.round(Number(out.kcal)); statusEl.textContent="‚úÖ IA OK"; iaChip.classList.remove("hidden"); }
      else { statusEl.textContent="‚ö†Ô∏è IA no devolvi√≥ kcal"; }
    }catch(e){ console.error(e); statusEl.textContent="‚ùå Error IA"; alert("Error IA: "+(e?.message||e)); }
    isIngesta ? refreshIngestaCTA() : refreshConsumoCTA();
    await writeTodaySummaryFromUI();
  }

  // ---------- Historial ----------
  async function loadHistory(limit=14){
    if(!uid||!historyList) return;
    historyList.innerHTML = "";
    const daysSnap = await getDocs(collection(db,"users",uid,"days"));
    const days = daysSnap.docs
      .map(d=>({ id:d.id, data:d.data()||{} }))
      .filter(d=>d.id !== todayKey)
      .sort((a,b)=> a.id < b.id ? 1 : -1)
      .slice(0, limit);

    for(const d of days){
      let bal = d.data?.totals?.balance;
      let meta = typeof d.data?.meta === "number" ? d.data.meta : metaKcal;
      if(typeof bal !== "number"){
        const [ingSnap, conSnap] = await Promise.all([
          getDocs(collection(db,"users",uid,"days",d.id,"ingestas")),
          getDocs(collection(db,"users",uid,"days",d.id,"consumos")),
        ]);
        const tIn = ingSnap.docs.reduce((s,x)=>s + (x.data()?.kcal||0),0);
        const tOut= conSnap.docs.reduce((s,x)=>s + (x.data()?.kcal||0),0);
        bal = tIn - tOut - meta;
      }
      const li=document.createElement("li");
      li.className="flex items-center justify-between chip rounded-xl px-3 py-2 text-sm";
      const cls = bal < 0 ? "text-emerald-400" : bal > 0 ? "text-rose-400" : "opacity-80";
      li.innerHTML = `<span>${d.id}</span><span class="mono ${cls}">${bal>0?"+":""}${bal} kcal</span>`;
      historyList.appendChild(li);
    }
  }

  // ---------- Habilitar/Deshabilitar CTAs ----------
  function refreshIngestaCTA(){
    const ok = (ingDesc?.value||"").trim() && toPosInt(ingKcal?.value)>0;
    addIngestaBtn.disabled = !ok;
  }
  function refreshConsumoCTA(){
    const ok = (conDesc?.value||"").trim() && toPosInt(conKcal?.value)>0;
    addConsumoBtn.disabled = !ok;
  }
  ingDesc?.addEventListener("input", refreshIngestaCTA);
  ingKcal?.addEventListener("input", refreshIngestaCTA);
  conDesc?.addEventListener("input", refreshConsumoCTA);
  conKcal?.addEventListener("input", refreshConsumoCTA);

  // ---------- IA / utilidades ----------
  async function estimateCaloriesViaAI(kind, description, base64Data, mimeType){
    const prefix= kind==="ingesta"
      ? "Eres nutricionista. Estima las calor√≠as ingeridas totales del alimento/comida."
      : "Eres entrenador. Estima las calor√≠as consumidas (gastadas) en la actividad.";
    const guidance='Devuelve SOLO JSON {"kcal": number, "item": string, "notes": string}. La clave debe llamarse EXACTAMENTE "kcal".';
    const parts=[{text:[prefix, description?("Descripci√≥n: "+description):"", guidance].filter(Boolean).join("\n")}];
    if(base64Data&&mimeType) parts.push({inlineData:{mimeType,data:base64Data}});
    const payload={ contents:[{role:"user",parts}], generationConfig:{responseMimeType:"application/json"} };
    const proxyUrl=(localStorage.getItem("GEMINI_PROXY_URL")||DEFAULT_PROXY_URL).trim();
    const r=await fetch(proxyUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({payload})});
    const j=await r.json(); const raw=typeof j?.text==="string"?j.text:JSON.stringify(j);
    return extractJsonFlexible(raw);
  }
  async function describeImage(base64, mimeType, contextText){
    const proxyUrl=(localStorage.getItem("GEMINI_PROXY_URL")||DEFAULT_PROXY_URL).trim();
    const payload={ contents:[{ role:"user", parts:[
      { text:`Describe brevemente, en una sola frase y en espa√±ol, ${contextText}. Sin formato, sin saltos, sin JSON.` },
      { inlineData:{ mimeType, data: base64 } }
    ]}] };
    const r=await fetch(proxyUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({payload})});
    const j=await r.json(); return (j?.text||"").replace(/```[\s\S]*?```/g,"").trim();
  }

  function getTodayKey(){ const d=new Date(), y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0"); return `${y}-${m}-${dd}`; }
  function escapeHtml(s=""){ return s.replace(/[&<>"']/g,(c)=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c])); }
  function slugify(s=""){ return s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim(); }
  function fileToBase64(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>{ const v=String(fr.result||""); const m=v.match(/^data:(.+?);base64,(.*)$/); if(!m) return rej(new Error("No se pudo leer el archivo.")); res({mimeType:m[1],data:m[2]}); }; fr.onerror=rej; fr.readAsDataURL(file); }); }
  function extractJsonFlexible(text){
    if(!text) return null;
    const fence=text.match(/```json\s*([\s\S]*?)```/i)||text.match(/```([\s\S]*?)```/);
    let raw=(fence?fence[1]:text).trim();
    let obj=null; try{ obj=JSON.parse(raw); }catch{}
    if(!obj){ const i=raw.indexOf("{"), j=raw.lastIndexOf("}"); if(i!==-1&&j!==-1&&j>i){ try{ obj=JSON.parse(raw.slice(i,j+1)); }catch{} } }
    if(!obj||typeof obj!=="object") return null;
    const norm={}; for(const [k,v] of Object.entries(obj)) norm[String(k).toLowerCase().trim()]=v;
    let kcal=norm.kcal??norm.calories??norm.cal??norm.energy??norm.energy_kcal??null;
    if(typeof kcal==="string"){ const m=kcal.replace(",",".").match(/-?\d+(\.\d+)?/); if(m) kcal=parseFloat(m[0]); }
    if(typeof kcal==="number"&&isFinite(kcal)) kcal=Math.round(kcal); else kcal=null;
    const item=(norm.item||norm.food||norm.name||"").toString();
    const notes=(norm.notes||norm.explanation||norm.reason||"").toString();
    return {kcal,item,notes};
  }
  function toPosInt(v){ const n=parseInt(String(v||"").trim(),10); return Number.isFinite(n)?n:0; }
</script>
</body>
</html>
