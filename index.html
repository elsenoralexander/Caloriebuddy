<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CalorieBuddy ¬∑ Diario</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body{min-height:100vh;background:#0b1324;color:#eaeef7}
  .card{background:#101a33;border:1px solid #223257;border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
  .chip{background:#152241;border:1px solid #2b3e69}
  .btn{transition:transform .05s ease,opacity .2s ease} .btn:active{transform:translateY(1px)}
  .mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,Menlo,monospace}
  input[type="file"]{display:none}
</style>
</head>
<body class="antialiased">
<header class="max-w-4xl mx-auto px-4 py-5 flex items-center justify-between">
  <h1 class="text-xl font-semibold">ü•ó CalorieBuddy</h1>
  <div class="flex items-center gap-2">
    <button id="openSettingsBtn" class="btn chip px-3 py-2 rounded-xl text-sm">‚öôÔ∏è Ajustes</button>
    <span class="chip text-xs px-3 py-2 rounded-xl">UID: <b id="uidSpan">‚Äî</b></span>
  </div>
</header>

<main class="max-w-4xl mx-auto px-4 pb-24 space-y-6">
  <!-- Resumen -->
  <section class="card p-4">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
      <div class="chip rounded-xl p-3">
        <div class="text-xs opacity-80">Ingestas</div>
        <div id="ingestasTotal" class="text-2xl mono">0</div>
      </div>
      <div class="chip rounded-xl p-3">
        <div class="text-xs opacity-80">Consumos</div>
        <div id="consumosTotal" class="text-2xl mono">0</div>
      </div>
      <div class="chip rounded-xl p-3">
        <div class="text-xs opacity-80">Meta diaria (kcal)</div>
        <div class="flex items-end gap-2">
          <input id="metaInput" type="number" min="0" step="10" value="2000" class="bg-transparent mono outline-none w-24">
          <button id="saveMetaBtn" class="btn chip rounded-md px-2 py-1 text-xs">Guardar</button>
        </div>
      </div>
      <div class="chip rounded-xl p-3">
        <div class="text-xs opacity-80">Balance <span id="todayLabel" class="opacity-70"></span></div>
        <div id="balanceSpan" class="text-2xl mono">0</div>
        <div class="text-xs opacity-70">negativo = d√©ficit</div>
      </div>
    </div>
  </section>

  <!-- Ingesta -->
  <section class="card p-4">
    <h2 class="font-semibold mb-3">‚ûï Nueva ingesta</h2>
    <div class="grid md:grid-cols-2 gap-4">
      <div class="space-y-3">
        <div class="chip rounded-xl p-3">
          <label class="text-sm opacity-80">Descripci√≥n</label>
          <input id="ingDesc" class="w-full bg-transparent outline-none" placeholder='p.ej. "huevo frito con patatas"'>
        </div>
        <div class="flex items-center gap-3 flex-wrap">
          <label class="btn chip rounded-xl px-3 py-2 text-sm cursor-pointer">üì∑ Adjuntar foto
            <input id="ingFile" type="file" accept="image/*">
          </label>
          <button id="ingAI" class="btn chip rounded-xl px-3 py-2 text-sm">ü§ñ Calcular con IA</button>
          <span id="ingAIStatus" class="text-xs opacity-75"></span>
        </div>
        <div class="flex items-center gap-3">
          <div class="chip rounded-xl p-2">
            <span class="text-xs opacity-80">kcal</span>
            <input id="ingKcal" type="number" min="0" class="w-24 bg-transparent mono outline-none ml-2" placeholder="90">
          </div>
          <button id="ingConsistenciaBtn" class="btn chip rounded-xl px-3 py-2 text-sm">üîç Consistencia</button>
        </div>
        <button id="addIngestaBtn" class="btn bg-sky-500 rounded-xl px-4 py-2 text-sm font-semibold hover:opacity-90">
          Guardar ingesta
        </button>
      </div>

      <div class="chip rounded-xl p-3">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm opacity-80">Listado de hoy</span>
          <span class="text-xs opacity-60">Ingestas</span>
        </div>
        <ul id="ingestasList" class="space-y-2 max-h-64 overflow-auto"></ul>
      </div>
    </div>
  </section>

  <!-- Consumo -->
  <section class="card p-4">
    <h2 class="font-semibold mb-3">üèÉ Nueva actividad (consumo)</h2>
    <div class="grid md:grid-cols-2 gap-4">
      <div class="space-y-3">
        <div class="chip rounded-xl p-3">
          <label class="text-sm opacity-80">Descripci√≥n</label>
          <input id="conDesc" class="w-full bg-transparent outline-none" placeholder='p.ej. "correr 30 min"'>
        </div>
        <div class="flex items-center gap-3 flex-wrap">
          <label class="btn chip rounded-xl px-3 py-2 text-sm cursor-pointer">üì∑ Adjuntar foto (opcional)
            <input id="conFile" type="file" accept="image/*">
          </label>
          <button id="conAI" class="btn chip rounded-xl px-3 py-2 text-sm">ü§ñ Estimar con IA</button>
          <span id="conAIStatus" class="text-xs opacity-75"></span>
        </div>
        <div class="flex items-center gap-3">
          <div class="chip rounded-xl p-2">
            <span class="text-xs opacity-80">kcal</span>
            <input id="conKcal" type="number" min="0" class="w-24 bg-transparent mono outline-none ml-2" placeholder="250">
          </div>
        </div>
        <button id="addConsumoBtn" class="btn bg-emerald-500 rounded-xl px-4 py-2 text-sm font-semibold hover:opacity-90">
          Guardar consumo
        </button>
      </div>

      <div class="chip rounded-xl p-3">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm opacity-80">Listado de hoy</span>
          <span class="text-xs opacity-60">Consumos</span>
        </div>
        <ul id="consumosList" class="space-y-2 max-h-64 overflow-auto"></ul>
      </div>
    </div>
  </section>
</main>

<!-- Ajustes -->
<dialog id="settingsDlg" class="card p-0 w-[95vw] max-w-xl">
  <form method="dialog">
    <div class="p-5">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">Ajustes</h3>
        <button class="chip px-2 py-1 rounded-lg">‚úñ</button>
      </div>

      <div class="space-y-4">
        <div class="chip rounded-xl p-3">
          <label class="block text-sm opacity-80 mb-1">Proxy URL (Firebase Function)</label>
          <input id="proxyUrlInput" class="w-full bg-transparent outline-none text-sm"
                 placeholder="https://REGION-PROYECTO.cloudfunctions.net/geminiGenerate">
          <p class="text-xs opacity-70 mt-1">Si lo dejas vac√≠o, se usa el fallback por defecto.</p>
        </div>
        <div class="chip rounded-xl p-3">
          <label class="block text-sm opacity-80 mb-1">Meta diaria (kcal)</label>
          <input id="metaDlgInput" type="number" min="0" step="10" class="bg-transparent outline-none w-32">
        </div>
      </div>

      <div class="mt-4 flex justify-end">
        <button id="settingsSaveBtn" class="btn bg-sky-500 rounded-xl px-4 py-2 text-sm font-semibold">Guardar</button>
      </div>
    </div>
  </form>
</dialog>

<!-- ===================== -->
<!--  SCRIPT PRINCIPAL     -->
<!-- ===================== -->
<script type="module">
  // ---------- Firebase por CDN ----------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, query, orderBy, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

  // Config de TU proyecto
const firebaseConfig = {
  apiKey: "AIzaSyBbQMzOlIrMvZ3r4DsbUFy22EMBJ6Zu3zM",
  authDomain: "caloriebuddy-48b3b.firebaseapp.com",
  projectId: "caloriebuddy-48b3b",
  storageBucket: "caloriebuddy-48b3b.firebasestorage.app",
  messagingSenderId: "561415163751",
  appId: "1:561415163751:web:23049923151bfb0163a9c2"
};

  // Fallback del proxy (puedes dejarlo as√≠)
  const DEFAULT_PROXY_URL = "https://europe-west1-caloriebuddy-48b3b.cloudfunctions.net/geminiGenerate";

  // ---------- Estado/UI ----------
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const $ = (s) => document.querySelector(s);
  const uidSpan = $("#uidSpan");
  const todayLabel = $("#todayLabel");
  const ingestasList = $("#ingestasList");
  const consumosList = $("#consumosList");
  const ingDesc = $("#ingDesc");
  const ingFile = $("#ingFile");
  const ingKcal = $("#ingKcal");
  const ingAI = $("#ingAI");
  const ingAIStatus = $("#ingAIStatus");
  const ingConsistenciaBtn = $("#ingConsistenciaBtn");
  const addIngestaBtn = $("#addIngestaBtn");
  const conDesc = $("#conDesc");
  const conFile = $("#conFile");
  const conKcal = $("#conKcal");
  const conAI = $("#conAI");
  const conAIStatus = $("#conAIStatus");
  const addConsumoBtn = $("#addConsumoBtn");
  const ingestasTotal = $("#ingestasTotal");
  const consumosTotal = $("#consumosTotal");
  const balanceSpan = $("#balanceSpan");
  const metaInput = $("#metaInput");
  const saveMetaBtn = $("#saveMetaBtn");
  const openSettingsBtn = $("#openSettingsBtn");
  const settingsDlg = $("#settingsDlg");
  const settingsSaveBtn = $("#settingsSaveBtn");
  const proxyUrlInput = $("#proxyUrlInput");
  const metaDlgInput = $("#metaDlgInput");

  let uid = null;
  let metaKcal = 2000;
  const todayKey = getTodayKey();
  if (todayLabel) todayLabel.textContent = `(${todayKey})`;

  // Consistencia local de ejemplo (por si no existe a√∫n en Firestore)
  const foodCalorieLookup = { "caf√© con leche": 90, "manzana": 52, "pl√°tano": 89, "huevo frito": 196 };

  // ---------- Ajustes ----------
  openSettingsBtn?.addEventListener("click", () => {
    proxyUrlInput.value = localStorage.getItem("GEMINI_PROXY_URL") || "";
    metaDlgInput.value = metaKcal;
    settingsDlg.showModal();
  });
  settingsSaveBtn?.addEventListener("click", (e) => {
    e.preventDefault();
    localStorage.setItem("GEMINI_PROXY_URL", proxyUrlInput.value.trim());
    const m = parseInt(metaDlgInput.value || "0", 10);
    if (!Number.isNaN(m) && m >= 0) {
      metaKcal = m; metaInput.value = m; saveUserMeta(m).catch(console.error); recomputeBalance();
    }
    settingsDlg.close();
  });

  metaInput?.addEventListener("change", () => {
    const v = parseInt(metaInput.value || "0", 10);
    if (!Number.isNaN(v) && v >= 0) metaKcal = v;
  });
  saveMetaBtn?.addEventListener("click", async () => {
    await saveUserMeta(metaKcal);
    alert("Meta guardada");
    recomputeBalance();
  });

  // ---------- Auth + carga ----------
  onAuthStateChanged(auth, async (user) => {
    if (!user) { try { await signInAnonymously(auth); } catch (e) { alert("Auth error: " + e.message); } return; }
    uid = user.uid;
    if (uidSpan) uidSpan.textContent = uid.slice(0,8) + "‚Ä¶";

    const uRef = doc(db, "users", uid);
    const uSnap = await getDoc(uRef);
    if (uSnap.exists()) metaKcal = uSnap.data().metaKcal ?? metaKcal;
    if (metaInput) metaInput.value = metaKcal;

    await loadDay();
  });

  async function saveUserMeta(v){ if(!uid) return; await setDoc(doc(db,"users",uid),{metaKcal:v},{merge:true}); }

  // ---------- Carga/render d√≠a ----------
  async function loadDay(){
    if(!uid) return;
    const ingRef = collection(db,"users",uid,"days",todayKey,"ingestas");
    const conRef = collection(db,"users",uid,"days",todayKey,"consumos");
    const [ingSnap, conSnap] = await Promise.all([
      getDocs(query(ingRef, orderBy("createdAt","asc"))),
      getDocs(query(conRef, orderBy("createdAt","asc")))
    ]);
    const ingestas = ingSnap.docs.map(d=>({id:d.id,...d.data()}));
    const consumos = conSnap.docs.map(d=>({id:d.id,...d.data()}));
    renderList(ingestasList, ingestas);
    renderList(consumosList, consumos);
    recomputeTotals(ingestas, consumos);
  }

  function renderList(container, items){
    if(!container) return;
    container.innerHTML = "";
    (items||[]).forEach(it=>{
      const li = document.createElement("li");
      li.className="chip rounded-xl px-3 py-2 flex items-center justify-between text-sm";
      li.innerHTML = `<span>${escapeHtml(it.descripcion||"(sin descripci√≥n)")}</span><span class="mono">${it.kcal||0} kcal</span>`;
      container.appendChild(li);
    });
  }

  function recomputeTotals(ingestas, consumos){
    const tIn = (ingestas||[]).reduce((s,x)=>s+(x.kcal||0),0);
    const tOut= (consumos||[]).reduce((s,x)=>s+(x.kcal||0),0);
    if(ingestasTotal) ingestasTotal.textContent = tIn;
    if(consumosTotal) consumosTotal.textContent = tOut;
    recomputeBalance();
  }
  function recomputeBalance(){
    const inV = parseInt(ingestasTotal?.textContent||"0",10)||0;
    const outV= parseInt(consumosTotal?.textContent||"0",10)||0;
    const bal = inV - outV - metaKcal;
    if(balanceSpan){
      balanceSpan.textContent = bal;
      balanceSpan.classList.toggle("text-emerald-400", bal < 0);
      balanceSpan.classList.toggle("text-rose-400", bal >= 0);
    }
  }

  // ---------- Guardar filas ----------
  addIngestaBtn?.addEventListener("click", async ()=>{
    const d=(ingDesc?.value||"").trim();
    const k=parseInt(ingKcal?.value||"0",10);
    if(!d) return alert("Escribe descripci√≥n");
    if(Number.isNaN(k)||k<=0) return alert("Indica kcal v√°lidas");
    await addDoc(collection(db,"users",uid,"days",todayKey,"ingestas"),{
      descripcion:d,kcal:k,createdAt:serverTimestamp()
    });
    await saveKnownCalories(d,k);
    if(ingDesc) ingDesc.value=""; if(ingKcal) ingKcal.value=""; if(ingFile) ingFile.value="";
    if(ingAIStatus) ingAIStatus.textContent="";
    await loadDay();
  });

  addConsumoBtn?.addEventListener("click", async ()=>{
    const d=(conDesc?.value||"").trim();
    const k=parseInt(conKcal?.value||"0",10);
    if(!d) return alert("Escribe descripci√≥n");
    if(Number.isNaN(k)||k<=0) return alert("Indica kcal v√°lidas");
    await addDoc(collection(db,"users",uid,"days",todayKey,"consumos"),{
      descripcion:d,kcal:k,createdAt:serverTimestamp()
    });
    if(conDesc) conDesc.value=""; if(conKcal) conKcal.value=""; if(conFile) conFile.value="";
    if(conAIStatus) conAIStatus.textContent="";
    await loadDay();
  });

  // ---------- Consistencia ----------
  ingConsistenciaBtn?.addEventListener("click", async ()=>{
    const d=(ingDesc?.value||"").trim(); if(!d) return;
    const known = await getKnownCalories(d);
    if(known!==null){ if(ingKcal) ingKcal.value=known; if(ingAIStatus) ingAIStatus.textContent="‚úîÔ∏è Consistencia"; }
    else { if(ingAIStatus) ingAIStatus.textContent="‚ÑπÔ∏è Sin consistencia"; }
  });

  async function saveKnownCalories(desc, kcal){
    if(!uid) return;
    const slug = slugify(desc); if(!slug) return;
    await setDoc(doc(db,"users",uid,"knownItems",slug),{descripcion:slug,calorias:Number(kcal)||0},{merge:true});
  }
  async function getKnownCalories(desc){
    if(!uid) return null;
    const slug = slugify(desc); if(!slug) return null;
    const ref = doc(db,"users",uid,"knownItems",slug);
    const snap= await getDoc(ref);
    if(snap.exists()) return Number(snap.data().calorias)||0;
    if(Object.prototype.hasOwnProperty.call(foodCalorieLookup,slug)) return Number(foodCalorieLookup[slug])||0;
    return null;
  }

  // ---------- IA por proxy ----------
  ingAI?.addEventListener("click", ()=>handleAI("ingesta"));
  conAI?.addEventListener("click", ()=>handleAI("consumo"));

  async function handleAI(kind){
    const isIngesta = kind==="ingesta";
    const descEl = isIngesta?ingDesc:conDesc;
    const fileEl = isIngesta?ingFile:conFile;
    const statusEl = isIngesta?ingAIStatus:conAIStatus;
    const kcalEl = isIngesta?ingKcal:conKcal;

    const desc=(descEl?.value||"").trim();
    const file=fileEl?.files?.[0]||null;

    if(isIngesta && desc){
      const known=await getKnownCalories(desc);
      if(known!==null){ if(kcalEl) kcalEl.value=known; if(statusEl) statusEl.textContent="‚úîÔ∏è Consistencia"; return; }
    }

    if(statusEl) statusEl.textContent="Analizando‚Ä¶";
    try{
      let base64=null,mime=null;
      if(file){ const r=await fileToBase64(file); base64=r.data; mime=r.mimeType; }
      const out=await estimateCaloriesViaAI(kind,desc,base64,mime);
      if(out?.kcal!=null){ if(kcalEl) kcalEl.value=Math.round(Number(out.kcal)); if(statusEl) statusEl.textContent="‚úÖ IA OK";
        if(isIngesta && desc && out.kcal) await saveKnownCalories(desc,Number(out.kcal));
      } else { if(statusEl) statusEl.textContent="‚ö†Ô∏è IA no devolvi√≥ kcal"; }
    }catch(e){ console.error(e); if(statusEl) statusEl.textContent="‚ùå Error IA"; alert("Error IA: "+(e?.message||e)); }
  }

  async function estimateCaloriesViaAI(kind, description, base64Data, mimeType){
    const prefix = kind==="ingesta"
      ? "Eres nutricionista. Estima las calor√≠as ingeridas totales del alimento/comida."
      : "Eres entrenador. Estima las calor√≠as consumidas (gastadas) en la actividad.";
    const guidance =
      'Devuelve SOLO JSON {"kcal": number, "item": string, "notes": string}. '+
      'La clave debe llamarse EXACTAMENTE "kcal". Sin texto fuera del JSON.';

    const parts=[{text:[prefix, description?("Descripci√≥n: "+description):"", guidance].filter(Boolean).join("\n")}];
    if(base64Data && mimeType) parts.push({inlineData:{mimeType,data:base64Data}});

    const payload={ contents:[{role:"user",parts}], generationConfig:{responseMimeType:"application/json"} };
    const proxyUrl=(localStorage.getItem("GEMINI_PROXY_URL")||DEFAULT_PROXY_URL).trim();

    const r=await fetch(proxyUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({payload})});
    const j=await r.json();
    const raw = typeof j?.text==="string" ? j.text : JSON.stringify(j);
    const parsed = extractJsonFlexible(raw);
    return parsed;
  }

  // ---------- Helpers ----------
  function getTodayKey(){
    const d=new Date(), y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }
  function escapeHtml(s=""){ return s.replace(/[&<>"']/g,(c)=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c])); }
  function slugify(s=""){ return s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim(); }
  function fileToBase64(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>{ const v=String(fr.result||""); const m=v.match(/^data:(.+?);base64,(.*)$/); if(!m) return rej(new Error("No se pudo leer el archivo.")); res({mimeType:m[1],data:m[2]}); }; fr.onerror=rej; fr.readAsDataURL(file); }); }
  function extractJsonFlexible(text){
    if(!text) return null;
    const fence=text.match(/```json\s*([\s\S]*?)```/i)||text.match(/```([\s\S]*?)```/);
    let raw=(fence?fence[1]:text).trim();
    let obj=null; try{ obj=JSON.parse(raw); }catch{}
    if(!obj){ const i=raw.indexOf("{"), j=raw.lastIndexOf("}"); if(i!==-1&&j!==-1&&j>i){ try{ obj=JSON.parse(raw.slice(i,j+1)); }catch{} } }
    if(!obj||typeof obj!=="object") return null;
    const norm={}; for(const [k,v] of Object.entries(obj)) norm[String(k).toLowerCase().trim()]=v;
    let kcal=norm.kcal??norm.calories??norm.cal??norm.energy??norm.energy_kcal??null;
    if(typeof kcal==="string"){ const m=kcal.replace(",",".").match(/-?\d+(\.\d+)?/); if(m) kcal=parseFloat(m[0]); }
    if(typeof kcal==="number"&&isFinite(kcal)) kcal=Math.round(kcal); else kcal=null;
    const item=(norm.item||norm.food||norm.name||"").toString();
    const notes=(norm.notes||norm.explanation||norm.reason||"").toString();
    return {kcal,item,notes};
  }
</script>
</body>
</html>
